# Quiz Game — API Design

## Базовый URL
```
/api/v1
```

## Аутентификация
- **Ведущий (JWT)**: `POST /auth/login` → токен → `Authorization: Bearer <token>`.
- **Бот (API Key)**: Заголовок `X-Bot-API-Key` (используется для внутренних/бот-эндпоинтов).
- **Flex Auth**: Некоторые эндпоинты принимают и JWT, и API Key.

---

## Эндпоинты

### Auth

| Метод | Путь               | Описание             | Auth |
|-------|---------------------|----------------------|------|
| POST  | `/auth/register`    | Регистрация ведущего | —    |
| POST  | `/auth/login`       | Авторизация          | —    |

### Settings

| Метод | Путь        | Описание                              | Auth |
|-------|-------------|---------------------------------------|------|
| GET   | `/settings` | Получить настройки (bot_token, bot_link) | JWT  |
| PUT   | `/settings` | Обновить настройки                    | JWT  |

### Quizzes

| Метод  | Путь                       | Описание                    | Auth |
|--------|-----------------------------|-----------------------------|------|
| GET    | `/quizzes`                  | Список квизов ведущего      | JWT  |
| POST   | `/quizzes`                  | Создать квиз                | JWT  |
| GET    | `/quizzes/:id`              | Получить квиз с категориями и вопросами | JWT  |
| PUT    | `/quizzes/:id`              | Обновить название квиза     | JWT  |
| DELETE | `/quizzes/:id`              | Удалить квиз                | JWT  |
| POST   | `/quizzes/:id/questions`    | Добавить вопрос             | JWT  |
| POST   | `/quizzes/:id/categories`   | Создать категорию           | JWT  |
| PUT    | `/quizzes/:id/reorder`      | Изменить порядок категорий и вопросов | JWT  |
| GET    | `/quizzes/:id/export`       | Экспорт квиза (`?format=json\|csv`) | JWT  |
| POST   | `/quizzes/:id/import`       | Импорт вопросов (multipart file) | JWT  |

### Questions

| Метод  | Путь                       | Описание            | Auth |
|--------|-----------------------------|----------------------|------|
| PUT    | `/questions/:id`            | Обновить вопрос      | JWT  |
| DELETE | `/questions/:id`            | Удалить вопрос       | JWT  |
| POST   | `/questions/:id/images`     | Добавить изображение | JWT  |

### Categories

| Метод  | Путь               | Описание            | Auth |
|--------|---------------------|----------------------|------|
| PUT    | `/categories/:id`   | Обновить категорию   | JWT  |
| DELETE | `/categories/:id`   | Удалить категорию    | JWT  |

### Images

| Метод  | Путь           | Описание            | Auth |
|--------|-----------------|----------------------|------|
| DELETE | `/images/:id`   | Удалить изображение  | JWT  |

### Upload

| Метод | Путь      | Описание                  | Auth |
|-------|-----------|---------------------------|------|
| POST  | `/upload` | Загрузить файл (multipart) | JWT  |

### Sessions

| Метод | Путь                        | Описание                        | Auth     |
|-------|------------------------------|---------------------------------|----------|
| GET   | `/sessions`                  | Список сессий ведущего          | JWT      |
| POST  | `/sessions`                  | Создать сессию                  | JWT      |
| GET   | `/sessions/:id`              | Состояние сессии                | JWT/Bot  |
| POST  | `/sessions/:id/reveal`       | Показать правильный ответ       | JWT      |
| POST  | `/sessions/:id/next`         | Следующий вопрос                | JWT      |
| POST  | `/sessions/:id/finish`       | Досрочно завершить сессию       | JWT      |
| GET   | `/sessions/:id/leaderboard`  | Таблица лидеров                 | JWT/Bot  |
| POST  | `/sessions/join`             | Присоединиться (по коду)        | Bot      |
| POST  | `/sessions/:id/answer`       | Отправить/изменить ответ        | Bot      |
| GET   | `/sessions/:id/my-result`    | Результат участника за вопрос   | Bot      |

### Telegram Users

| Метод | Путь                                  | Описание                | Auth |
|-------|----------------------------------------|-------------------------|------|
| POST  | `/telegram-users`                      | Создать/получить юзера  | Bot  |
| PUT   | `/telegram-users/:telegram_id/nickname`| Обновить ник            | Bot  |
| GET   | `/telegram-users/:telegram_id/history` | История игр участника   | Bot  |

### Internal

| Метод | Путь                   | Описание                            | Auth |
|-------|-------------------------|--------------------------------------|------|
| GET   | `/internal/bot-tokens`  | Список токенов ботов всех ведущих   | Bot  |

---

## Webhook (Telegram)

| Метод | Путь                      | Описание                       | Auth                              |
|-------|----------------------------|--------------------------------|-----------------------------------|
| POST  | `/webhook/bot/:secret`     | Приём обновлений от Telegram   | `X-Telegram-Bot-Api-Secret-Token` |

Бот-менеджер автоматически регистрирует webhooks при обнаружении новых токенов в БД (проверка каждые 30 секунд).

---

## WebSocket

| Путь                  | Описание                                     |
|-----------------------|-----------------------------------------------|
| `/ws/session/:id`     | Real-time обновления сессии для экрана ведущего |

---

## Статусы сессии

| Статус     | Описание                                        |
|------------|--------------------------------------------------|
| `waiting`  | Ожидание участников (показ QR-кода)              |
| `question` | Вопрос показан, приём ответов                    |
| `revealed` | Ответ показан, ответы не принимаются             |
| `finished` | Квиз завершён, доступна таблица лидеров          |

## Формат импорта/экспорта

### JSON
```json
{
  "title": "Название квиза",
  "categories": [
    {
      "title": "Категория",
      "questions": [
        {
          "text": "Текст вопроса",
          "options": [
            { "text": "Вариант", "is_correct": true, "color": "#e21b3c" }
          ]
        }
      ]
    }
  ],
  "questions": []
}
```

### CSV
```
category,question,option1,option2,option3,option4,correct,color1,color2,color3,color4
"Категория","Вопрос?","Вариант 1","Вариант 2","Вариант 3","Вариант 4","2","#e21b3c","#1368ce","#d89e00","#26890c"
```
`correct` — номер правильного варианта (1-4).
